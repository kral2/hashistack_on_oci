#!/bin/sh

# Last update : October, 2021
# Author: cetin.ardal@oracle.com
# Description: Generate a tfvars file containing the latest Packer build artifact id

script_name=$(basename "$0")
version="0.1.0"
echo "$script_name - version $version"
echo "Generates a tfvars file containing the latest Packer build artifact id and copy it to the designated Terraform module folder."
echo ""

timestamp=$(date "+%Y-%m-%d %H:%M")

image_ocid=$(jq -r '.builds[-1].artifact_id' packer-manifest.json)

output_file="compute_instance_image_source_ocid.auto.tfvars"
terraform_module_path="../provision"

echo "Artifact OCID: $image_ocid"
echo "output file: $terraform_module_path/$output_file"

{
    echo "# Terraform file autogenerated by Packer. It contains the latest Packer Build artifact ID."
    echo "# $timestamp"
    echo ""
    echo "source_ocid=\"$image_ocid\""
} > "$terraform_module_path/$output_file"
